# FinConnect CRM - Customer 360 Logic Specification

## 1. Overview
The **Customer 360 (C360)** module is the central workspace for agents, designed to provide a comprehensive view of the customer's relationship with the NBFC. It dynamically adapts its interface and logic based on whether the user is an existing customer (**ETB**) or a new prospect/lead (**NTB**).

## 2. Component Architecture
**File:** `components/Customer360.tsx`

The component handles state for the customer profile, active assets, interaction history, and the AI Sales Coach.

### Key Props
- `customer`: Core identity data (Name, KYC, Risk, Scores).
- `loans` & `investments`: Portfolio arrays.
- `interactions`: Omni-channel history (Calls, Web visits, etc.).
- `isNTB` (Boolean): **Critical Flag**. Determines if the view is for a "New-to-Bank" lead or an existing customer.
- `investmentDropOffData`: Optional data structure containing incomplete application details for recovery scenarios.

---

## 3. Core Logic Flows

### 3.1 Mode Detection (NTB vs ETB)
The logic branches significantly based on the `isNTB` flag:

| Feature | Existing Customer (ETB) | New Lead (NTB) |
| :--- | :--- | :--- |
| **Default Tab** | `Overview` | `Sales Coach` (Prioritizes Conversion) |
| **Risk Indicator** | Shows specific Risk Category (Low/Med/High) | Shows "Assessing" or N/A |
| **Credit Score** | Displays actual CIBIL/Credit Score | Displays N/A or "Fetching" |
| **Relationship Score**| Calculated (0-100) based on tenure/holdings | 0 (No relationship yet) |
| **Alerts** | Operational (EMI Overdue, Maturity) | Behavioral (Web Drop-off, High Intent) |

### 3.2 Tab Logic

#### A. Sales Coach (AI-Driven)
- **Engine:** Integrates with `AIDecisionEngine` class (`services/aiDecisionEngine.ts`).
- **Initialization:** Created via `useRef` to persist state across re-renders without resetting the conversation.
- **Logic:** 
  1. **Scripting:** Displays dynamic `agentScript` based on the current node in the decision tree.
  2. **Objection Handling:** Provides buttons for customer responses (Positive, Negative, Objection).
  3. **Scoring:** Updates `intent` and `eligibility` scores in real-time based on selected responses.
  4. **Guidance:** Shows "Persuasion Tips" (psychological cues) and a context-aware "Product Cheat Sheet".

#### B. Overview
- **Relationship Summary:** 
  - **ETB:** Aggregates active Loans and Investments into a summary card. Shows past (closed) products for context.
  - **NTB:** Shows a "Prospect Status" card indicating no active products and prompts usage of the Sales Coach.
- **Offers Engine:**
  - **ETB:** Shows "Top-up" or "Retention" offers based on probability.
  - **NTB:** Shows "Acquisition" offers (e.g., New Customer FD Scheme).

#### C. Investments (Drop-off Recovery)
This tab contains specialized logic for handling **Digital Drop-offs**:
- Checks for `investmentDropOffData`.
- **Form Rendering:** If data exists, it renders a read-only view of the incomplete application (Certificate No, Cheque No, etc.).
- **Action Triggers:** Boolean flags (`enableTdsCertificate`, `enableSOA`, etc.) enable specific service buttons to help the agent resolve the customer's blocker immediately.

#### D. History (Omni-Channel)
- Renders a vertical timeline of `interactions`.
- **Visual Cues:** Different icons/colors for Calls (Blue), SMS/Email (Purple), and Web/App (Orange).
- **Metadata:** Displays sentiment badges (Positive/Negative) and delivery status.

### 3.3 Privacy & Security
- **PII Masking:** Utilizes the `PrivacyText` component for Mobile, Email, and PAN.
  - Default: Masked (e.g., `XXXXX-XX789`).
  - Action: Clicking the eye icon unmasks the data.
  - **Audit:** The unmasking action triggers a console log (simulating a backend audit trail call) to ensure compliance (Requirement 3.8.3).

### 3.4 Communication Actions
- **Modal Logic:** The "Send SMS/Email" button opens `isCommModalOpen`.
- **Template Engine:** 
  - Selects templates from `mockTemplates`.
  - **String Interpolation:** Replaces placeholders (e.g., `{name}`, `{amount}`) with actual data from the `customer` object before previewing.

---

## 4. Data Integration Points
The logic relies on specific data shapes defined in `types.ts`:
- **Customer Identity:** `Customer` interface.
- **Financial Assets:** `Loan` and `Investment` interfaces.
- **Service Requests:** `Ticket` interface.
- **AI State:** `AIState` and `QuestionNode` interfaces.

## 5. Visual Hierarchy & UX
- **Header:** Sticky Identity header with quick actions (Communication, Privacy Toggle).
- **Alerts Bar:** Dynamic warning/info banners inserted below the header based on logic (e.g., if `loan.dpd > 0`).
- **Layout:** Responsive Grid (1 column on mobile, 4 columns on large screens).
